{% extends "base.html" %}

{% block title %}í‰ê°€ ê²°ê³¼ - {{ assessment[8] }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>í‰ê°€ ê²°ê³¼ ìƒì„¸</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                <h4>ê¸°ë³¸ ì •ë³´</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>íšŒì‚¬ëª…:</strong> {{ assessment[8] }}</p>
                        <p><strong>í‰ê°€ì:</strong> {{ assessment[2] }}</p>
                        <p><strong>í‰ê°€ì¼:</strong> {{ assessment[3][:16] }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>ì´ì :</strong> {{ assessment[4] }}/140ì </p>
                        <div class="maturity-level level-{{ assessment[5] }}">
                            ì„±ìˆ™ë„ Level {{ assessment[5] }}
                        </div>
                    </div>
                </div>
                {% if assessment[6] %}
                <div class="mt-3">
                    <strong>ë©”ëª¨:</strong>
                    <p class="text-muted">{{ assessment[6] }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h4>ì˜ì—­ë³„ ì ìˆ˜</h4>
            </div>
            <div class="card-body">
                {% for category in category_scores %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><strong>{{ category[1] }}</strong></span>
                        <span>{{ category[3] }}/{{ category[4] }}ì  ({{ "%.1f"|format((category[3]/category[4])*100) }}%)</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ (category[3]/category[4])*100 }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4>ìƒì„¸ ì‘ë‹µ</h4>
            </div>
            <div class="card-body">
                {% for result in detailed_results %}
                <div class="mb-2">
                    <strong>{{ result[0] }}</strong> {{ result[1] }}: 
                    <span class="badge bg-primary">{{ result[2] }}ì </span>
                    {{ result[3] }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>ë ˆì´ë” ì°¨íŠ¸</h5>
            </div>
            <div class="card-body">
                <canvas id="radarChart" width="300" height="300"></canvas>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>ì„±ìˆ™ë„ ê°€ì´ë“œ</h5>
            </div>
            <div class="card-body">
                <div class="maturity-level level-1 mb-2">Level 1: ì´ˆê¸° ë‹¨ê³„ (28-56ì )</div>
                <div class="maturity-level level-2 mb-2">Level 2: ê´€ë¦¬ ë‹¨ê³„ (57-84ì )</div>
                <div class="maturity-level level-3 mb-2">Level 3: ì •ì˜ ë‹¨ê³„ (85-112ì )</div>
                <div class="maturity-level level-4 mb-2">Level 4: ìµœì í™” ë‹¨ê³„ (113-128ì )</div>
                <div class="maturity-level level-5">Level 5: í˜ì‹  ë‹¨ê³„ (129-140ì )</div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body text-center">
                <small class="text-muted">ğŸ’¡ ì°¨íŠ¸ì˜ ì˜ì—­ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ë¶„ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
            </div>
        </div>
    </div>
</div>

<!-- Drill-down ëª¨ë‹¬ -->
<div class="modal fade" id="drilldownModal" tabindex="-1" aria-labelledby="drilldownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drilldownModalLabel">ìƒì„¸ ë¶„ì„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 id="modalCategoryName" class="mb-0"></h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="prevCategoryBtn">ì´ì „</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="nextCategoryBtn">ë‹¤ìŒ</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="drilldownChart" width="400" height="400"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>ì§ˆë¬¸ë³„ ì ìˆ˜</h6>
                            </div>
                            <div class="card-body" id="questionScores">
                                <!-- ì§ˆë¬¸ë³„ ì ìˆ˜ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mainChartData = null;
let mainChart = null;
let drilldownChart = null;
let currentCategoryIndex = 0;
let categoryIds = [];

// ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
fetch('/api/assessment/{{ assessment[0] }}/chart')
    .then(response => response.json())
    .then(data => {
        mainChartData = data;
        
        // ì¹´í…Œê³ ë¦¬ ID ë§¤í•‘ (ìˆœì„œëŒ€ë¡œ 1, 2, 3, 4)
        categoryIds = [1, 2, 3, 4];
        
        const ctx = document.getElementById('radarChart').getContext('2d');
        mainChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: data.categories,
                datasets: [{
                    label: 'í˜„ì¬ ì ìˆ˜',
                    data: data.percentages,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        currentCategoryIndex = index;
                        showDrilldown(categoryIds[index], data.categories[index]);
                    }
                }
            }
        });
    });

// ë“œë¦´ë‹¤ìš´ ëª¨ë‹¬ í‘œì‹œ
function showDrilldown(categoryId, categoryName) {
    fetch(`/api/assessment/{{ assessment[0] }}/category/${categoryId}/detail`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ ì œëª© ì„¤ì •
            document.getElementById('modalCategoryName').textContent = data.categoryName;
            
            // ë“œë¦´ë‹¤ìš´ ì°¨íŠ¸ ìƒì„±
            createDrilldownChart(data);
            
            // ì§ˆë¬¸ë³„ ì ìˆ˜ í‘œì‹œ
            displayQuestionScores(data);
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('drilldownModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ë“œë¦´ë‹¤ìš´ ì°¨íŠ¸ ìƒì„±
function createDrilldownChart(data) {
    const canvas = document.getElementById('drilldownChart');
    const ctx = canvas.getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (drilldownChart) {
        drilldownChart.destroy();
    }
    
    drilldownChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: data.questions.map((q, i) => `Q${i+1}`),
            datasets: [{
                label: 'ì ìˆ˜',
                data: data.percentages,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgb(255, 99, 132)',
                pointBackgroundColor: 'rgb(255, 99, 132)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(255, 99, 132)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            return data.questions[context.dataIndex];
                        }
                    }
                }
            }
        }
    });
}

// ì§ˆë¬¸ë³„ ì ìˆ˜ í‘œì‹œ
function displayQuestionScores(data) {
    const container = document.getElementById('questionScores');
    container.innerHTML = '';
    
    data.questions.forEach((question, index) => {
        const score = data.scores[index];
        const percentage = data.percentages[index];
        
        const questionDiv = document.createElement('div');
        questionDiv.className = 'mb-2';
        questionDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <small><strong>Q${index + 1}</strong></small>
                <small>${score}/5ì  (${percentage}%)</small>
            </div>
            <div class="progress progress-sm">
                <div class="progress-bar" style="width: ${percentage}%"></div>
            </div>
            <small class="text-muted">${question}</small>
        `;
        container.appendChild(questionDiv);
    });
}

// ì´ì „/ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('prevCategoryBtn').addEventListener('click', () => {
    currentCategoryIndex = (currentCategoryIndex - 1 + categoryIds.length) % categoryIds.length;
    showDrilldown(categoryIds[currentCategoryIndex], mainChartData.categories[currentCategoryIndex]);
});

document.getElementById('nextCategoryBtn').addEventListener('click', () => {
    currentCategoryIndex = (currentCategoryIndex + 1) % categoryIds.length;
    showDrilldown(categoryIds[currentCategoryIndex], mainChartData.categories[currentCategoryIndex]);
});

// ëª¨ë‹¬ ë‹«í˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
document.getElementById('drilldownModal').addEventListener('hidden.bs.modal', function () {
    // ë“œë¦´ë‹¤ìš´ ì°¨íŠ¸ ì œê±°
    if (drilldownChart) {
        drilldownChart.destroy();
        drilldownChart = null;
    }
    
    // backdrop ê°•ì œ ì œê±°
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    // body í´ë˜ìŠ¤ ì •ë¦¬
    document.body.classList.remove('modal-open');
    document.body.style.paddingRight = '';
});
</script>
{% endblock %}
